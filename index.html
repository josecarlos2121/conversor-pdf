<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8" />
  <title>Conversor Imagem ⇄ PDF</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    .app {
      background: #ffffff;
      margin: 24px;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      max-width: 640px;
      width: 100%;
    }

    h1 {
      font-size: 1.6rem;
      margin-top: 0;
      margin-bottom: 0.5rem;
    }

    p {
      margin-top: 0;
      color: #555;
    }

    .mode-select {
      display: flex;
      gap: 12px;
      margin: 16px 0 20px;
      flex-wrap: wrap;
    }

    .mode-select label {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fafafa;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .mode-select input[type="radio"] {
      accent-color: #0b7285;
    }

    .field {
      margin-bottom: 16px;
    }

    .field label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
    }

    input[type="file"] {
      width: 100%;
    }

    button {
      border: none;
      padding: 10px 18px;
      border-radius: 999px;
      background: #0b7285;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status {
      margin-top: 10px;
      font-size: 0.9rem;
      color: #555;
    }

    .status.error {
      color: #c92a2a;
    }

    .results {
      margin-top: 20px;
      padding-top: 12px;
      border-top: 1px solid #eee;
      font-size: 0.95rem;
    }

    .results h2 {
      margin-top: 0;
      font-size: 1.1rem;
    }

    .download-link {
      display: block;
      margin: 4px 0;
      word-break: break-all;
    }

    .output-format {
      margin-bottom: 20px;
    }
  </style>

  <!-- jsPDF: gerar PDF no browser -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- PDF.js: ler/renderizar PDF no browser (versão estável 2.10.377) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <script>
    // Configurar o worker de PDF.js (obrigatório)
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js";
    }
  </script>
</head>
<body>
<div class="app">
  <h1>Conversor Imagem ⇄ PDF</h1>
  <p>Converte JPG / PNG / BMP → PDF e PDF → imagens (JPG ou PNG).</p>

  <div class="mode-select">
    <label>
      <input type="radio" name="mode" value="img-to-pdf" checked />
      Imagens → PDF
    </label>
    <label>
      <input type="radio" name="mode" value="pdf-to-img" />
      PDF → Imagens
    </label>
  </div>

  <div class="field">
    <label id="file-label" for="file-input">Escolhe as imagens (JPG/PNG/BMP):</label>
    <input
      id="file-input"
      type="file"
      multiple
      accept=".jpg,.jpeg,.png,.bmp,image/jpeg,image/png,image/bmp,application/pdf"
    />
  </div>

  <div class="field output-format" id="output-format" style="display:none;">
    <label>Formato de saída (PDF → Imagem):</label>
    <label><input type="radio" name="imgformat" value="jpeg" checked> JPG</label>
    <label><input type="radio" name="imgformat" value="png"> PNG</label>
  </div>

  <button id="convert-btn">Converter</button>
  <div id="status" class="status"></div>

  <div id="results" class="results" style="display:none;">
    <h2>Resultados</h2>
    <div id="downloads"></div>
  </div>
</div>

<script>
  const modeInputs = document.querySelectorAll('input[name="mode"]');
  const fileInput = document.getElementById('file-input');
  const fileLabel = document.getElementById('file-label');
  const convertBtn = document.getElementById('convert-btn');
  const statusEl = document.getElementById('status');
  const resultsEl = document.getElementById('results');
  const downloadsEl = document.getElementById('downloads');
  const outputFormatBox = document.getElementById('output-format');

  function getMode() {
    return Array.from(modeInputs).find(r => r.checked).value;
  }

  function updateInputs() {
    const mode = getMode();

    if (mode === "img-to-pdf") {
      fileLabel.textContent = "Escolhe as imagens (JPG/PNG/BMP):";
      fileInput.accept = ".jpg,.jpeg,.png,.bmp,image/jpeg,image/png,image/bmp";
      fileInput.multiple = true;
      outputFormatBox.style.display = "none";
    } else {
      fileLabel.textContent = "Escolhe o ficheiro PDF:";
      fileInput.accept = ".pdf,application/pdf";
      fileInput.multiple = false;
      outputFormatBox.style.display = "block";
    }

    fileInput.value = "";
    downloadsEl.innerHTML = "";
    resultsEl.style.display = "none";
    statusEl.textContent = "";
    statusEl.classList.remove("error");
  }

  modeInputs.forEach(r => r.addEventListener("change", updateInputs));
  updateInputs();

  function setStatus(msg, isError = false) {
    statusEl.textContent = msg;
    statusEl.classList.toggle("error", isError);
  }

  function startProcessing() {
    convertBtn.disabled = true;
    setStatus("A processar...");
    resultsEl.style.display = "none";
    downloadsEl.innerHTML = "";
  }

  function endProcessing() {
    convertBtn.disabled = false;
  }

  /* ---------- IMAGENS → PDF ---------- */
  async function imagesToPdf(files) {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation: "p", unit: "mm", format: "a4" });

    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();

    for (let i = 0; i < files.length; i++) {
      const file = files[i];

      // Lê a imagem como dataURL
      const dataUrl = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = e => reject(e);
        reader.readAsDataURL(file);
      });

      const img = await new Promise((resolve, reject) => {
        const image = new Image();
        image.onload = () => resolve(image);
        image.onerror = e => reject(e);
        image.src = dataUrl;
      });

      // Mantém proporção da imagem
      const ratio = img.width / img.height;
      let w = pageW - 20;
      let h = w / ratio;

      if (h > pageH - 20) {
        h = pageH - 20;
        w = h * ratio;
      }

      const x = (pageW - w) / 2;
      const y = (pageH - h) / 2;

      if (i > 0) pdf.addPage();
      // jsPDF aceita JPG/PNG via dataURL. Tipo "JPEG" funciona na prática para ambos.
      pdf.addImage(dataUrl, "JPEG", x, y, w, h);
    }

    const blob = pdf.output("blob");
    return URL.createObjectURL(blob);
  }

  /* ---------- PDF → IMAGENS ---------- */
  async function pdfToImages(file, format) {
    if (!window.pdfjsLib) {
      throw new Error("PDF.js não carregou.");
    }

    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    const numPages = pdf.numPages;
    const pages = [];

    for (let n = 1; n <= numPages; n++) {
      const page = await pdf.getPage(n);
      const viewport = page.getViewport({ scale: 1.5 });

      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      canvas.width = viewport.width;
      canvas.height = viewport.height;

      await page.render({ canvasContext: ctx, viewport }).promise;

      const mime = format === "png" ? "image/png" : "image/jpeg";
      const dataUrl = canvas.toDataURL(mime, 0.92);
      pages.push({ n, url: dataUrl });
    }

    return pages;
  }

  /* ---------- BOTÃO ---------- */
  convertBtn.addEventListener("click", async () => {
    const files = fileInput.files;
    const mode = getMode();

    if (!files || files.length === 0) {
      setStatus("Escolhe pelo menos um ficheiro.", true);
      return;
    }

    try {
      startProcessing();

      if (mode === "img-to-pdf") {
        const pdfUrl = await imagesToPdf(files);

        resultsEl.style.display = "block";
        const link = document.createElement("a");
        link.href = pdfUrl;
        link.download = "imagens_convertidas.pdf";
        link.className = "download-link";
        link.textContent = "Descarregar PDF gerado";
        downloadsEl.appendChild(link);

        setStatus("Conversão concluída!");
      } else {
        const format = document.querySelector('input[name="imgformat"]:checked').value;
        const pages = await pdfToImages(files[0], format);

        resultsEl.style.display = "block";
        if (pages.length === 0) {
          downloadsEl.textContent = "Nenhuma página encontrada no PDF.";
        } else {
          pages.forEach(p => {
            const link = document.createElement("a");
            link.href = p.url;
            link.download = `pagina_${p.n}.${format}`;
            link.className = "download-link";
            link.textContent = `Página ${p.n} → descarregar (${format.toUpperCase()})`;
            downloadsEl.appendChild(link);
          });
        }

        setStatus("Conversão concluída!");
      }
    } catch (err) {
      console.error(err);
      setStatus("Ocorreu um erro na conversão. Verifica o ficheiro e a ligação à internet.", true);
    } finally {
      endProcessing();
    }
  });
</script>
</body>
</html>
